pipeline {
    agent any

    environment {
        PYSPARK_PYTHON = "/usr/bin/python3"
        PYSPARK_DRIVER_PYTHON = "/usr/bin/python3"
    }

    stages {
        stage('Upgrade pip') {
            steps {
                sh '''
                    python3 -m pip install --upgrade pip setuptools wheel
                '''
            }
        }

        stage('Install Python dependencies') {
            steps {
                sh '''
                    python3 -m pip install --user -r TFL_Streaming/requirements.txt
                '''
            }
        }

        stage('Run Producer (one-off)') {
            steps {
                sh '''
                    echo "Running single-run TFL producer..."
                    spark-submit \
                      --master local \
                      --packages "org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7","com.lihaoyi:requests_2.11:0.7.1" \
                      TFL_Streaming/src/producer.py 2>&1 | tee logs/producer.log
                '''
            }
        }

//         stage('Run Consumer (batch for debugging)') {
//             steps {
//                 sh '''
//                     echo "Running streaming consumer in batch mode (one trigger) to completion..."
//                     spark-submit \
//                       --master local \
//                       --packages "org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7" \
//                       TFL_Streaming/src/consumer.py
//                 '''
//             }
//         }

        stage('Start Consumer (streaming)') {
            steps {
                sh '''
                    echo "Starting streaming consumer in background..."
                    nohup spark-submit \
                      --master local \
                      --packages "org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7" \
                      TFL_Streaming/src/consumer.py 2>&1 | tee logs/consumer.log &
                    echo $! > consumer.pid
                    echo "Consumer started with PID $(cat consumer.pid)"
                '''
            }
        }

        stage('Refresh Impala Metadata') {
            steps {
                sh '''
                    impala-shell -q "REFRESH streaming_tfl_db.tfl_streaming_arrivals;"
                '''
            }
        }
    }

    post {
        always {
            // Keep consumer running; just notify pipeline completion
            sh '''
                echo "Jenkins pipeline finished. Consumer is running in background."
            '''
        }
    }
}
