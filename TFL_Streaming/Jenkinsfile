pipeline {
    agent any

    environment {
        PYSPARK_PYTHON = "/usr/bin/python3"
        PYSPARK_DRIVER_PYTHON = "/usr/bin/python3"
    }

    stages {
        stage('Upgrade pip') {
            steps {
                sh '''
                    python3 -m pip install --upgrade pip setuptools wheel
                '''
            }
        }

        stage('Install Python dependencies') {
            steps {
                sh '''
                    python3 -m pip install --user -r TFL_Streaming/requirements.txt
                '''
            }
        }
        
        stage('Start Producer') {
            steps {
                sh '''
                    spark-submit \
                      --master local \
                      --packages "org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7","com.lihaoyi:requests_2.11:0.7.1" \
                      TFL_Streaming/src/producer.py &
                    echo $! > producer.pid
                '''
            }
        }

        stage('Start Consumer') {
            steps {
                sh '''
                    sleep 5
                    spark-submit \
                      --master local \
                      --packages "org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7" \
                      TFL_Streaming/src/consumer.py &
                    echo $! > consumer.pid
                '''
            }
        }

        stage('Run for 30 seconds') {
            steps {
                sh 'sleep 30'
            }
        }

        stage('Stop Processes') {
            steps {
                sh '''
                    if [ -f producer.pid ]; then kill $(cat producer.pid) || true; fi
                    if [ -f consumer.pid ]; then kill $(cat consumer.pid) || true; fi
                '''
            }
        }

        stage('Refresh Impala Metadata') {
            steps {
                sh '''
                    impala-shell -q "REFRESH streaming_tfl_db.tfl_streaming_arrivals;"
                '''
            }
        }
    }

    post {
        always {
            sh 'rm -f producer.pid consumer.pid'
        }
    }
}
