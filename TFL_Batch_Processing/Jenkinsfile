pipeline {
    agent any

    environment {
        PYSPARK_PYTHON        = "/usr/bin/python3"
        PYSPARK_DRIVER_PYTHON = "/usr/bin/python3"
        SPARK_SUBMIT          = "spark-submit"
    }

    stages {

        stage('Upgrade pip') {
            steps {
                sh '''
                    python3 -m pip install --upgrade pip setuptools wheel
                '''
            }
        }
       /*
        stage('1. Data Extraction from API') {
            steps {
                echo "Running API data extraction (3 cycles)..."
                sh '''
                    set -e
                    cd TFL_Batch_Processing/src/bronze
                    python3 rawdataextraction.py
                '''
            }
        }

        stage('2. Data Integration (Postgres Load)') {
            steps {
                echo "Running Data Integration — Loading API data into Postgres..."
                sh '''
                    set -e
                    cd TFL_Batch_Processing
                    python3 src/bronze/dataintegration.py inc
                '''
            }
        }
       
        stage('Incremental Ingestion (Sqoop → Hive → HDFS)') {
            steps {
                echo "Running Incremental Ingestion Script..."
                sh '''
                    set -e
                    cd TFL_Batch_Processing/src/bronze
                    chmod +x incremental_script.sh
                    ./incremental_script.sh
                '''
            }
        }

        stage('Repair Hive Partitions (Raw)') {
            steps {
                echo "Running MSCK REPAIR TABLE on all RAW tables..."
                sh '''
                    beeline -u "jdbc:hive2://ip-172-31-14-3.eu-west-2.compute.internal:10000/batchprocessing_tfl_db" -e "
                        MSCK REPAIR TABLE tfl_bakerloo_lines_raw;
                        MSCK REPAIR TABLE tfl_central_lines_raw;
                        MSCK REPAIR TABLE tfl_metropolitan_lines_raw;
                        MSCK REPAIR TABLE tfl_northern_lines_raw;
                        MSCK REPAIR TABLE tfl_piccadilly_lines_raw;
                        MSCK REPAIR TABLE tfl_victoria_lines_raw;
                    "
                '''
            }
        }
        */
        stage('Run Silver Transformations') {
            steps {
                echo "Running Silver layer Spark transformations..."
                sh '''
                    set -e
                    cd TFL_Batch_Processing
                    spark-submit --master yarn --deploy-mode client src/silver/Transformations_final.py
                '''
            }
        }

        stage('Repair Hive Partitions (Silver)') {
            steps {
                echo "Repairing Silver Hive partitions..."
                sh '''
                    beeline -u "jdbc:hive2://ip-172-31-14-3.eu-west-2.compute.internal:10000/batchprocessing_tfl_db" -e "
                        MSCK REPAIR TABLE tfl_gold_table7;
                    "
                '''
            }
        }

        stage('Create Gold Tables (Hive)') {
            steps {
                echo "Running Gold Layer Hive Script..."
                sh '''
                    set -e
                    cd TFL_Batch_Processing/src/gold
                    hive -f tfl_gold_layer.hql
                '''
            }
        }

    }
}





